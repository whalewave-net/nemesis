---
- hosts: localhost
  connection: local
  tasks:
    - name: Deploy vultr servers
      vars:
        hostname: "{{  item.split('.')[0] | lower }}"
        hc_vault_server: "vault.whalewave.net:8200"
        hc_vault_token: "{{ vault_token }}"
        cloudflare_api_key: "{{ cloudflare_api_key }}"
        
        public_key_file_name: "/home/vagrant/generated-host-keys/{{ item.split('.')[0] | lower }}/id_rsa.pub"
        private_key_file_name: "/home/vagrant/generated-host-keys/{{ item.split('.')[0] | lower }}/id_rsa"

      include_tasks: create_vultr_server.yml
      loop: "{{ groups['vultr_servers'] }}"

- hosts: all
  gather_facts: no

  become: true

  pre_tasks:
    - name:
      wait_for_connection:
        delay: 5
        timeout: 600

  tasks:

    - name: Gather facts for first time
      setup:

    - name: Add shellwhale public key
      authorized_key:
        user: "shellwhale"
        state: present
        key: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDD15zcZ5fttHN7HQ3zjb+x9qWfEbw3reU7TShxAz429y6pRgmB2vqrYqmi/e3ikRC09ESyX+N9WGiH4kW/WPXxOWMsvuADrJJpfBe4nepvmZWe0KnVZ13Rveyh1HyWliUF9TXxox0vcwVIt5mqVhTCsYDrU+tzg2SZtN32p4+REsmPqoExqmQsurGbzY2cz5RU9hxH1uTrxbucuAowMeSVp3jnS399ZjqLlvMQGUH8U8rW1ykMcl+FoEMqmNe0R7oscUhni2ZwHX9c22Z2RspulMX51I/xJqjI0OeStN2HmUKjBUOaKWOQcGlOKg+RjSEy3V6HQOYQrF16oEIxkzV7"

    - name: Add motd
      template:
          src: templates/motd.j2
          dest: /etc/motd

  roles:
    - role: common-tools
    